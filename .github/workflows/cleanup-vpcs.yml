name: Cleanup VPCs

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (list VPCs without deleting)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      regions:
        description: 'AWS regions to scan (comma-separated or "all")'
        required: true
        default: 'all'
        type: string
      name_patterns:
        description: 'VPC name patterns to delete (comma-separated)'
        required: true
        default: 'prospect,cdot,todo'
        type: string
      confirm_delete:
        description: 'Type "DELETE" to confirm (required when dry_run is false)'
        required: false
        default: ''
        type: string

env:
  AWS_REGION: us-west-2

jobs:
  cleanup-vpcs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate inputs
        run: |
          if [[ "${{ inputs.dry_run }}" == "false" && "${{ inputs.confirm_delete }}" != "DELETE" ]]; then
            echo "::error::You must type 'DELETE' in confirm_delete to proceed with actual deletion"
            exit 1
          fi
          echo "Dry run: ${{ inputs.dry_run }}"
          echo "Regions: ${{ inputs.regions }}"
          echo "Name patterns: ${{ inputs.name_patterns }}"

      - name: Get AWS regions
        id: get-regions
        run: |
          if [[ "${{ inputs.regions }}" == "all" ]]; then
            REGIONS=$(aws ec2 describe-regions --query "Regions[].RegionName" --output text | tr '\t' ' ')
          else
            REGIONS=$(echo "${{ inputs.regions }}" | tr ',' ' ')
          fi
          echo "regions=$REGIONS" >> $GITHUB_OUTPUT
          echo "Scanning regions: $REGIONS"

      - name: Find and delete VPCs
        run: |
          set -e

          DRY_RUN="${{ inputs.dry_run }}"
          PATTERNS="${{ inputs.name_patterns }}"
          REGIONS="${{ steps.get-regions.outputs.regions }}"

          # Convert patterns to array
          IFS=',' read -ra PATTERN_ARRAY <<< "$PATTERNS"

          echo "=========================================="
          echo "VPC Cleanup Script"
          echo "=========================================="
          echo "Dry Run: $DRY_RUN"
          echo "Patterns: ${PATTERN_ARRAY[*]}"
          echo "=========================================="

          TOTAL_FOUND=0
          TOTAL_DELETED=0

          # Function to delete VPC and all its dependencies
          delete_vpc() {
            local vpc_id=$1
            local region=$2
            local vpc_name=$3

            echo ""
            echo "Processing VPC: $vpc_id ($vpc_name) in $region"
            echo "----------------------------------------"

            if [[ "$DRY_RUN" == "true" ]]; then
              echo "[DRY RUN] Would delete VPC: $vpc_id ($vpc_name)"
              return 0
            fi

            # 1. Delete NAT Gateways
            echo "  Deleting NAT Gateways..."
            NAT_GWS=$(aws ec2 describe-nat-gateways --region "$region" \
              --filter "Name=vpc-id,Values=$vpc_id" "Name=state,Values=available,pending" \
              --query "NatGateways[].NatGatewayId" --output text 2>/dev/null || echo "")
            for nat in $NAT_GWS; do
              echo "    Deleting NAT Gateway: $nat"
              aws ec2 delete-nat-gateway --region "$region" --nat-gateway-id "$nat" || true
            done

            # Wait for NAT Gateways to be deleted
            if [[ -n "$NAT_GWS" ]]; then
              echo "  Waiting for NAT Gateways to be deleted..."
              sleep 30
            fi

            # 2. Delete VPC Endpoints
            echo "  Deleting VPC Endpoints..."
            ENDPOINTS=$(aws ec2 describe-vpc-endpoints --region "$region" \
              --filters "Name=vpc-id,Values=$vpc_id" \
              --query "VpcEndpoints[].VpcEndpointId" --output text 2>/dev/null || echo "")
            for ep in $ENDPOINTS; do
              echo "    Deleting VPC Endpoint: $ep"
              aws ec2 delete-vpc-endpoints --region "$region" --vpc-endpoint-ids "$ep" || true
            done

            # 3. Detach and delete Internet Gateways
            echo "  Deleting Internet Gateways..."
            IGWS=$(aws ec2 describe-internet-gateways --region "$region" \
              --filters "Name=attachment.vpc-id,Values=$vpc_id" \
              --query "InternetGateways[].InternetGatewayId" --output text 2>/dev/null || echo "")
            for igw in $IGWS; do
              echo "    Detaching IGW: $igw"
              aws ec2 detach-internet-gateway --region "$region" --internet-gateway-id "$igw" --vpc-id "$vpc_id" || true
              echo "    Deleting IGW: $igw"
              aws ec2 delete-internet-gateway --region "$region" --internet-gateway-id "$igw" || true
            done

            # 4. Delete Subnets
            echo "  Deleting Subnets..."
            SUBNETS=$(aws ec2 describe-subnets --region "$region" \
              --filters "Name=vpc-id,Values=$vpc_id" \
              --query "Subnets[].SubnetId" --output text 2>/dev/null || echo "")
            for subnet in $SUBNETS; do
              echo "    Deleting Subnet: $subnet"
              aws ec2 delete-subnet --region "$region" --subnet-id "$subnet" || true
            done

            # 5. Delete custom Route Tables (skip main)
            echo "  Deleting Route Tables..."
            RTS=$(aws ec2 describe-route-tables --region "$region" \
              --filters "Name=vpc-id,Values=$vpc_id" \
              --query "RouteTables[?Associations[?Main!=\`true\`]].RouteTableId" --output text 2>/dev/null || echo "")
            for rt in $RTS; do
              # Disassociate first
              ASSOCS=$(aws ec2 describe-route-tables --region "$region" --route-table-ids "$rt" \
                --query "RouteTables[].Associations[?!Main].RouteTableAssociationId" --output text 2>/dev/null || echo "")
              for assoc in $ASSOCS; do
                echo "    Disassociating Route Table: $assoc"
                aws ec2 disassociate-route-table --region "$region" --association-id "$assoc" || true
              done
              echo "    Deleting Route Table: $rt"
              aws ec2 delete-route-table --region "$region" --route-table-id "$rt" || true
            done

            # 6. Delete Network ACLs (skip default)
            echo "  Deleting Network ACLs..."
            ACLS=$(aws ec2 describe-network-acls --region "$region" \
              --filters "Name=vpc-id,Values=$vpc_id" "Name=default,Values=false" \
              --query "NetworkAcls[].NetworkAclId" --output text 2>/dev/null || echo "")
            for acl in $ACLS; do
              echo "    Deleting Network ACL: $acl"
              aws ec2 delete-network-acl --region "$region" --network-acl-id "$acl" || true
            done

            # 7. Delete Security Groups (skip default)
            echo "  Deleting Security Groups..."
            SGS=$(aws ec2 describe-security-groups --region "$region" \
              --filters "Name=vpc-id,Values=$vpc_id" \
              --query "SecurityGroups[?GroupName!='default'].GroupId" --output text 2>/dev/null || echo "")
            for sg in $SGS; do
              echo "    Deleting Security Group: $sg"
              aws ec2 delete-security-group --region "$region" --group-id "$sg" || true
            done

            # 8. Release Elastic IPs associated with the VPC
            echo "  Releasing Elastic IPs..."
            EIPS=$(aws ec2 describe-addresses --region "$region" \
              --filters "Name=domain,Values=vpc" \
              --query "Addresses[?AssociationId==null].AllocationId" --output text 2>/dev/null || echo "")
            # Note: This is a simplified check - in production you'd want to verify EIP association with VPC resources

            # 9. Delete the VPC
            echo "  Deleting VPC: $vpc_id"
            if aws ec2 delete-vpc --region "$region" --vpc-id "$vpc_id" 2>/dev/null; then
              echo "  ✅ Successfully deleted VPC: $vpc_id ($vpc_name)"
              return 0
            else
              echo "  ❌ Failed to delete VPC: $vpc_id - may have remaining dependencies"
              return 1
            fi
          }

          # Scan each region
          for region in $REGIONS; do
            echo ""
            echo "=========================================="
            echo "Scanning region: $region"
            echo "=========================================="

            # Get all VPCs in the region
            VPC_DATA=$(aws ec2 describe-vpcs --region "$region" \
              --query "Vpcs[].[VpcId,Tags[?Key=='Name'].Value|[0]]" \
              --output text 2>/dev/null || echo "")

            if [[ -z "$VPC_DATA" ]]; then
              echo "No VPCs found in $region"
              continue
            fi

            # Process each VPC
            while IFS=$'\t' read -r vpc_id vpc_name; do
              # Skip if no name
              if [[ "$vpc_name" == "None" || -z "$vpc_name" ]]; then
                continue
              fi

              # Check if name matches any pattern
              MATCH=false
              for pattern in "${PATTERN_ARRAY[@]}"; do
                pattern=$(echo "$pattern" | xargs)  # trim whitespace
                if [[ "${vpc_name,,}" == "${pattern,,}"* ]]; then
                  MATCH=true
                  break
                fi
              done

              if [[ "$MATCH" == "true" ]]; then
                ((TOTAL_FOUND++))
                echo ""
                echo "Found matching VPC: $vpc_id - $vpc_name (region: $region)"

                if delete_vpc "$vpc_id" "$region" "$vpc_name"; then
                  if [[ "$DRY_RUN" == "false" ]]; then
                    ((TOTAL_DELETED++))
                  fi
                fi
              fi
            done <<< "$VPC_DATA"
          done

          echo ""
          echo "=========================================="
          echo "Summary"
          echo "=========================================="
          echo "Total VPCs found matching patterns: $TOTAL_FOUND"
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "Mode: DRY RUN - No VPCs were deleted"
            echo ""
            echo "To actually delete these VPCs, re-run with:"
            echo "  - dry_run: false"
            echo "  - confirm_delete: DELETE"
          else
            echo "Total VPCs deleted: $TOTAL_DELETED"
          fi
          echo "=========================================="

      - name: Summary
        run: |
          echo "## VPC Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Regions**: ${{ inputs.regions }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Patterns**: ${{ inputs.name_patterns }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "> **Note**: This was a dry run. No VPCs were actually deleted." >> $GITHUB_STEP_SUMMARY
          else
            echo "> **Warning**: VPCs matching the patterns have been deleted." >> $GITHUB_STEP_SUMMARY
          fi
