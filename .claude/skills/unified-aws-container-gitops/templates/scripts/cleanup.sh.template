#!/bin/bash
# Unified AWS Container GitOps - Cleanup Script
# Usage: ./cleanup.sh <app-name>
#
# IMPORTANT: This script deletes resources. Use with caution.

set -e

APP_NAME="${1:?Usage: ./cleanup.sh <app-name>}"

# Pre-configured values
EKS_REGION="us-west-1"
EKS_CLUSTER="argocd-nonprod-eks"
HOSTED_ZONE_ID="Z00814191D1XSXELJVTKT"
DOMAIN="opsera-labs.com"

echo ""
echo "========================================"
echo "  CLEANUP: $APP_NAME"
echo "========================================"
echo ""
echo "  This will delete:"
echo "    - ArgoCD Application"
echo "    - Kubernetes Namespace"
echo "    - ArgoCD Repository Secret"
echo "    - Route53 DNS Record (if exists)"
echo ""
read -p "  Continue? (y/N): " confirm
if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "  Cancelled."
    exit 0
fi
echo ""

# Connect to cluster
echo ">>> Connecting to EKS cluster..."
aws eks update-kubeconfig --name "$EKS_CLUSTER" --region "$EKS_REGION" > /dev/null

# Step 1: Delete ArgoCD Application FIRST
echo ">>> Deleting ArgoCD application..."
if kubectl get application "$APP_NAME" -n argocd 2>/dev/null; then
    kubectl delete application "$APP_NAME" -n argocd --wait=true
    echo "    Deleted ArgoCD application $APP_NAME"
else
    echo "    ArgoCD application $APP_NAME not found"
fi

# Step 2: Wait and delete namespace
echo ">>> Waiting for namespace termination..."
sleep 10

if kubectl get namespace "$APP_NAME" 2>/dev/null; then
    kubectl delete namespace "$APP_NAME" --wait=true --timeout=120s || \
        echo "    Namespace deletion timed out, may still be terminating"
    echo "    Deleted namespace $APP_NAME"
else
    echo "    Namespace $APP_NAME not found"
fi

# Step 3: Delete ArgoCD repo secret
echo ">>> Deleting ArgoCD repository secret..."
SECRET_NAME="repo-${APP_NAME}"
if kubectl get secret "$SECRET_NAME" -n argocd 2>/dev/null; then
    kubectl delete secret "$SECRET_NAME" -n argocd
    echo "    Deleted secret $SECRET_NAME"
else
    echo "    Secret $SECRET_NAME not found"
fi

# Step 4: Clean up Route53 record (if ExternalDNS didn't)
echo ">>> Checking Route53 record..."
DNS_NAME="${APP_NAME}.agents.${DOMAIN}"
RECORD_VALUE=$(aws route53 list-resource-record-sets \
    --hosted-zone-id "$HOSTED_ZONE_ID" \
    --query "ResourceRecordSets[?Name=='${DNS_NAME}.'].ResourceRecords[0].Value" \
    --output text 2>/dev/null || echo "")

if [ -n "$RECORD_VALUE" ] && [ "$RECORD_VALUE" != "None" ]; then
    echo "    Found DNS record pointing to: $RECORD_VALUE"
    aws route53 change-resource-record-sets \
        --hosted-zone-id "$HOSTED_ZONE_ID" \
        --change-batch "{
            \"Changes\": [{
                \"Action\": \"DELETE\",
                \"ResourceRecordSet\": {
                    \"Name\": \"${DNS_NAME}\",
                    \"Type\": \"CNAME\",
                    \"TTL\": 300,
                    \"ResourceRecords\": [{\"Value\": \"$RECORD_VALUE\"}]
                }
            }]
        }" > /dev/null
    echo "    Deleted Route53 record for $DNS_NAME"
else
    echo "    No Route53 record found for $DNS_NAME"
fi

echo ""
echo "========================================"
echo "  CLEANUP COMPLETE!"
echo "========================================"
echo ""
echo "  Optional: Delete ECR repositories (retains image history):"
echo "    aws ecr delete-repository --repository-name $APP_NAME --force"
echo "    aws ecr delete-repository --repository-name $APP_NAME-backend --force"
echo "    aws ecr delete-repository --repository-name $APP_NAME-frontend --force"
echo ""
echo "========================================"
