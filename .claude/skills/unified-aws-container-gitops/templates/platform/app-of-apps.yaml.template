# =============================================================================
# ARGOCD APP-OF-APPS PATTERN
# =============================================================================
# This is the "master" ArgoCD Application that manages all other applications.
# It's the GitOps equivalent of "infrastructure as code" for your apps.
#
# Structure:
#   gitops/
#   ├── app-of-apps.yaml       ← This file (manages everything below)
#   ├── platform/              ← Platform components (ExternalDNS, etc.)
#   │   └── external-dns.yaml
#   └── apps/                  ← Application-specific ArgoCD manifests
#       ├── my-app-dev.yaml
#       ├── my-app-staging.yaml
#       └── my-app-prod.yaml
#
# Replace:
#   {{GITOPS_REPO_URL}} - URL of your GitOps repository
#   {{GITOPS_BRANCH}} - Branch to watch (usually main)
#
# =============================================================================

---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: app-of-apps
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default

  source:
    repoURL: {{GITOPS_REPO_URL}}
    targetRevision: {{GITOPS_BRANCH}}
    path: gitops/apps
    directory:
      recurse: true

  destination:
    server: https://kubernetes.default.svc
    namespace: argocd

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
