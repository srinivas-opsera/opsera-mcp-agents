# =============================================================================
# ARGOCD INSTALLATION MANIFEST
# =============================================================================
# This installs ArgoCD on your EKS cluster. Run ONCE per cluster.
#
# Installation:
#   kubectl create namespace argocd
#   kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
#   kubectl apply -f argocd-install.yaml
#
# Access ArgoCD UI:
#   kubectl port-forward svc/argocd-server -n argocd 8080:443
#   # Get initial password:
#   kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
#
# =============================================================================

---
# ArgoCD Server Service (LoadBalancer for external access)
apiVersion: v1
kind: Service
metadata:
  name: argocd-server-lb
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-server
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
spec:
  type: LoadBalancer
  ports:
    - name: https
      port: 443
      targetPort: 8080
  selector:
    app.kubernetes.io/name: argocd-server

---
# ArgoCD ConfigMap for custom settings
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # Enable anonymous read-only access (optional)
  # users.anonymous.enabled: "true"

  # Timeout settings
  timeout.reconciliation: "180s"
  timeout.hard.reconciliation: "0s"

  # Application health checks
  resource.customizations: |
    networking.k8s.io/Ingress:
      health.lua: |
        hs = {}
        hs.status = "Healthy"
        return hs
    v1/Service:
      health.lua: |
        hs = {}
        if obj.spec.type == "LoadBalancer" then
          if obj.status.loadBalancer.ingress then
            hs.status = "Healthy"
          else
            hs.status = "Progressing"
          end
        else
          hs.status = "Healthy"
        end
        return hs

---
# ArgoCD RBAC ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  # Default policy - admin has full access
  policy.default: role:readonly
  policy.csv: |
    g, admin, role:admin
